rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isSystemAdmin() {
      return getUserRole() == 'system_admin';
    }
    
    function isStandardUser() {
      return getUserRole() == 'standard_user';
    }
    
    // Facility documents and images
    match /facilities/{facilityId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isSystemAdmin();
    }
    
    // Renter documents (ID copies, contracts, etc.)
    match /renters/{renterId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (isSystemAdmin() || isStandardUser());
    }
    
    // Lease documents
    match /leases/{leaseId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (isSystemAdmin() || isStandardUser());
    }
    
    // Payment receipts and proof
    match /payments/{paymentId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (isSystemAdmin() || isStandardUser());
    }
    
    // Room images and documents
    match /rooms/{roomId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (isSystemAdmin() || isStandardUser());
    }
    
    // User profile images
    match /users/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
        (isSystemAdmin() || request.auth.uid == userId);
    }
    
    // General uploads (for receipts, reports, etc.)
    match /uploads/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (isSystemAdmin() || isStandardUser());
    }
    
    // Maintenance documents and images
    match /maintenance/{maintenanceId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (isSystemAdmin() || isStandardUser());
    }
  }
}
